rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ===================================================================
    // HELPER FUNCTIONS
    // ===================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidTimestamp(ts) {
      return ts is timestamp && ts <= request.time;
    }
    
    function isValidString(str, maxLength) {
      return str is string && str.size() > 0 && str.size() <= maxLength;
    }
    
    function isValidNumber(num, min, max) {
      return num is number && num >= min && num <= max;
    }
    
    function isValidEmail(email) {
      return email is string && (email.size() == 0 || email.matches('.*@.*\\..*'));
    }
    
    function isValidUrl(url) {
      return url is string && (url.size() == 0 || url.matches('https?://.*') || url.matches('gs://.*'));
    }
    
    // ===================================================================
    // APP CONFIGURATION
    // ===================================================================

    match /app_config/{document} {
      // SECURITY: Require authentication to read config (API keys are stored here)
      // This ensures only authenticated app users can access configuration
      // Note: For production, consider moving to server-side config loading
      allow read: if isAuthenticated(); // Require authentication for security
      allow write: if false; // Only admins can write (via Firebase Console or server-side scripts)
      
      // Future enhancement: Restrict to admin users only for better security
      // allow read: if isAuthenticated() && 
      //   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // ===================================================================
    // USER DATA COLLECTIONS (Nested Structure)
    // ===================================================================
    
    match /users/{userId} {
      // Root user document - owner only access
      allow read, write: if isOwner(userId);
      
      // =================================================================
      // FOOD ENTRIES
      // Path: users/{userId}/entries/{entryId}
      // =================================================================
      
      match /entries/{entryId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(resource.data.name, 200) &&
          isValidNumber(resource.data.calories, 0, 10000) &&
          isValidTimestamp(resource.data.timestamp) &&
          (!('imageUrl' in resource.data) || isValidUrl(resource.data.imageUrl));
      }
      
      // =================================================================
      // GOALS SUB-COLLECTION
      // Path: users/{userId}/goals/{documentId}
      // =================================================================
      
      match /goals/{documentId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          (!('calorieGoal' in resource.data) || isValidNumber(resource.data.calorieGoal, 500, 10000)) &&
          (!('waterGlassesGoal' in resource.data) || isValidNumber(resource.data.waterGlassesGoal, 1, 50)) &&
          (!('stepsPerDayGoal' in resource.data) || isValidNumber(resource.data.stepsPerDayGoal, 1000, 100000)) &&
          (!('weightGoal' in resource.data) || isValidNumber(resource.data.weightGoal, 10, 1000)) &&
          (!('bmiGoal' in resource.data) || isValidNumber(resource.data.bmiGoal, 10, 50));
      }
      
      // =================================================================
      // STREAKS SUB-COLLECTION
      // Path: users/{userId}/streaks/{documentId}
      // =================================================================
      
      match /streaks/{documentId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId);
      }
      
      // =================================================================
      // PROFILE SUB-COLLECTION
      // Path: users/{userId}/profile/{document}
      // =================================================================
      
      match /profile/{document} {
        allow read, write: if isOwner(userId);
        
        // userData document
        match /userData {
          allow create, update: if isOwner(userId) &&
            (!('onboardingCompleted' in resource.data) || resource.data.onboardingCompleted is bool) &&
            (!('email' in resource.data) || isValidEmail(resource.data.email)) &&
            (!('photoURL' in resource.data) || isValidUrl(resource.data.photoURL)) &&
            (!('displayName' in resource.data) || isValidString(resource.data.displayName, 100));
        }
        
        // goals document (legacy path)
        match /goals {
          allow read, write: if isOwner(userId);
          allow create, update: if isOwner(userId) &&
            (!('calorieGoal' in resource.data) || isValidNumber(resource.data.calorieGoal, 500, 10000)) &&
            (!('waterGlassesGoal' in resource.data) || isValidNumber(resource.data.waterGlassesGoal, 1, 50)) &&
            (!('stepsPerDayGoal' in resource.data) || isValidNumber(resource.data.stepsPerDayGoal, 1000, 100000)) &&
            (!('weightGoal' in resource.data) || isValidNumber(resource.data.weightGoal, 10, 1000)) &&
            (!('bmiGoal' in resource.data) || isValidNumber(resource.data.bmiGoal, 10, 50));
        }
        
        // preferences document
        match /preferences {
          allow create, update: if isOwner(userId);
        }
        
        // achievements document
        match /achievements {
          allow read, write: if isOwner(userId);
          allow create, update: if isOwner(userId);
        }
      }
      
      // =================================================================
      // DAILY SUMMARY (Nested - both naming conventions)
      // Path: users/{userId}/dailySummary/{dateKey}
      // Path: users/{userId}/daily_summaries/{dateKey}
      // =================================================================
      
      match /dailySummary/{dateKey} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(dateKey, 20) &&
          isValidNumber(resource.data.caloriesConsumed, 0, 50000) &&
          isValidNumber(resource.data.caloriesBurned, 0, 10000) &&
          isValidNumber(resource.data.steps, 0, 100000) &&
          isValidTimestamp(resource.data.date);
      }
      
      match /daily_summaries/{dateKey} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(dateKey, 20) &&
          isValidNumber(resource.data.caloriesConsumed, 0, 50000) &&
          isValidNumber(resource.data.caloriesBurned, 0, 10000) &&
          isValidNumber(resource.data.steps, 0, 100000) &&
          isValidTimestamp(resource.data.date);
      }
      
      // =================================================================
      // TRAINER CHATS
      // Path: users/{userId}/trainerChats/{messageId}
      // =================================================================
      
      match /trainerChats/{messageId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(resource.data.sender, 50) &&
          isValidString(resource.data.text, 5000) &&
          isValidTimestamp(resource.data.timestamp) &&
          resource.data.sender in ['user', 'assistant', 'Sisir'];
      }
      
      // =================================================================
      // CHAT SESSIONS
      // Path: users/{userId}/chatSessions/{sessionId}
      // =================================================================
      
      match /chatSessions/{sessionId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(resource.data.title, 200) &&
          isValidTimestamp(resource.data.lastMessageTime) &&
          (!('messageCount' in resource.data) || isValidNumber(resource.data.messageCount, 0, 10000));
      }
      
      // =================================================================
      // WEIGHT LOGS
      // Path: users/{userId}/weightLogs/{logId}
      // =================================================================
      
      match /weightLogs/{logId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidNumber(resource.data.weight, 10, 1000) &&
          isValidTimestamp(resource.data.date) &&
          (!('bmi' in resource.data) || isValidNumber(resource.data.bmi, 10, 50));
      }
      
      // =================================================================
      // PROGRESS (for analytics)
      // Path: users/{userId}/progress/{progressId}
      // =================================================================
      
      match /progress/{progressId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId);
      }
      
      // =================================================================
      // FOOD HISTORY
      // Path: users/{userId}/food_history/entries/{entryId}
      // =================================================================
      
      match /food_history/{allPaths=**} {
        allow read, write: if isOwner(userId);
        
        match /entries/{entryId} {
          allow create, update: if isOwner(userId) &&
            isValidString(resource.data.foodName, 200) &&
            isValidNumber(resource.data.calories, 0, 10000) &&
            isValidNumber(resource.data.weightGrams, 0, 100000) &&
            isValidString(resource.data.source, 50) &&
            isValidTimestamp(resource.data.timestamp) &&
            resource.data.source in ['camera_scan', 'barcode_scan', 'manual_entry'] &&
            (!('imagePath' in resource.data) || isValidUrl(resource.data.imagePath));
        }
      }
    }
    
    // ===================================================================
    // TOP-LEVEL COLLECTIONS
    // ===================================================================
    
    // Tasks Collection - User-specific tasks
    match /tasks/{taskId} {
      // Tasks belong to authenticated users
      allow read: if isAuthenticated() && 
        (resource == null || resource.data.userId == request.auth.uid || !('userId' in resource.data));
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isValidString(request.resource.data.title, 200) &&
        (!('description' in request.resource.data) || isValidString(request.resource.data.description, 1000));
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // Chat Sessions (Top-level)
    match /chat_sessions/{sessionId} {
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.userId == request.auth.uid || !('userId' in resource.data));
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isValidTimestamp(request.resource.data.timestamp);
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // Daily Goals (Top-level)
    match /daily_goals/{goalId} {
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.userId == request.auth.uid || !('userId' in resource.data));
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isValidNumber(request.resource.data.calorieGoal, 500, 10000);
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // Daily Summaries (Top-level)
    match /daily_summaries/{summaryId} {
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.userId == request.auth.uid || !('userId' in resource.data));
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isValidTimestamp(request.resource.data.date);
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // User Analytics (Top-level)
    match /user_analytics/{analyticsId} {
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.userId == request.auth.uid || !('userId' in resource.data));
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // User Insights (Top-level)
    match /user_insights/{insightId} {
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.userId == request.auth.uid || !('userId' in resource.data));
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // User Profiles (Top-level)
    match /user_profiles/{profileId} {
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.userId == request.auth.uid || profileId == request.auth.uid);
      allow create: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid || profileId == request.auth.uid) &&
        (!('email' in request.resource.data) || isValidEmail(request.resource.data.email));
      allow update, delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || profileId == request.auth.uid);
    }
    
    // User Settings (Top-level)
    match /user_settings/{settingsId} {
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.userId == request.auth.uid || settingsId == request.auth.uid);
      allow create: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid || settingsId == request.auth.uid);
      allow update, delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || settingsId == request.auth.uid);
    }
    
    // Food History (Top-level)
    match /food_history/{userId} {
      // User's food history collection
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      match /entries/{entryId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
        allow create, update: if isAuthenticated() && request.auth.uid == userId &&
          isValidString(request.resource.data.foodName, 200) &&
          isValidNumber(request.resource.data.calories, 0, 10000) &&
          isValidTimestamp(request.resource.data.timestamp);
      }
    }
    
    // User Goals (Top-level - legacy support)
    match /user_goals/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      allow create, update: if isAuthenticated() && request.auth.uid == userId &&
        (!('calorieGoal' in request.resource.data) || isValidNumber(request.resource.data.calorieGoal, 500, 10000)) &&
        (!('waterGlassesGoal' in request.resource.data) || isValidNumber(request.resource.data.waterGlassesGoal, 1, 50)) &&
        (!('stepsPerDayGoal' in request.resource.data) || isValidNumber(request.resource.data.stepsPerDayGoal, 1000, 100000)) &&
        (!('weightGoal' in request.resource.data) || isValidNumber(request.resource.data.weightGoal, 10, 1000));
    }
    
    // Weight Logs (Top-level)
    match /weightLogs/{logId} {
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.userId == request.auth.uid || !('userId' in resource.data));
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isValidNumber(request.resource.data.weight, 10, 1000);
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // ===================================================================
    // PUBLIC FOOD DATABASE
    // ===================================================================
    
    match /food_database/{document} {
      // Public read access for food database
      allow read: if true;
      // Only admins can write (via Firebase Console or server-side scripts)
      allow write: if false;
    }
    
    // ===================================================================
    // CONNECTIVITY TEST (for network connectivity checks)
    // ===================================================================
    
    match /connectivity/{document} {
      // Allow authenticated users to read connectivity test document
      // This is used by the app to check network connectivity
      allow read: if isAuthenticated();
      // No writes needed - this is just for connectivity testing
      allow write: if false;
    }
    
    // ===================================================================
    // ADMIN COLLECTIONS
    // ===================================================================
    
    match /admin/{document=**} {
      // Server-side only - no client access
      allow read, write: if false;
    }
  }
}
