rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidTimestamp(timestamp) {
      return timestamp is timestamp && timestamp <= request.time;
    }
    
    function isValidString(str, maxLength) {
      return str is string && str.size() > 0 && str.size() <= maxLength;
    }
    
    function isValidNumber(num, min, max) {
      return num is number && num >= min && num <= max;
    }
    
    // App configuration - read-only for authenticated users
    match /app_config/{document} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins can write
    }
    
    // Main user collection - simplified structure
    match /users/{userId} {
      // User profile document
      allow read, write: if isOwner(userId);
      
      // Food entries
      match /food_entries/{entryId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(resource.data.name, 200) &&
          isValidNumber(resource.data.calories, 0, 10000) &&
          isValidTimestamp(resource.data.timestamp);
      }
      
      // Daily summaries
      match /daily_summaries/{dateKey} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(resource.data.dateKey, 20) &&
          isValidNumber(resource.data.caloriesConsumed, 0, 50000) &&
          isValidNumber(resource.data.caloriesBurned, 0, 10000) &&
          isValidNumber(resource.data.steps, 0, 100000) &&
          isValidTimestamp(resource.data.date);
      }
      
      // Weight logs
      match /weight_logs/{logId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidNumber(resource.data.weight, 10, 1000) &&
          isValidTimestamp(resource.data.date) &&
          isValidTimestamp(resource.data.createdAt);
      }
      
      // User goals (single document)
      match /goals/goal {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidNumber(resource.data.calorieGoal, 500, 10000) &&
          isValidNumber(resource.data.waterGlassesGoal, 1, 50) &&
          isValidNumber(resource.data.stepsPerDayGoal, 1000, 100000);
      }
      
      // Achievements
      match /achievements/{achievementId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(resource.data.title, 100) &&
          isValidString(resource.data.description, 500) &&
          isValidNumber(resource.data.points, 0, 10000) &&
          isValidTimestamp(resource.data.unlockedAt);
      }
      
      // Streaks (single document)
      match /streaks/streak {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidNumber(resource.data.totalActiveStreaks, 0, 100) &&
          isValidNumber(resource.data.longestOverallStreak, 0, 10000) &&
          isValidTimestamp(resource.data.lastActivityDate);
      }
      
      // AI trainer chats
      match /chats/{sessionId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          isValidString(resource.data.title, 200) &&
          isValidTimestamp(resource.data.timestamp);
      }
    }
    
    // Public food database
    match /food_database/{document} {
      allow read: if true;
      allow write: if false; // Only admins can write
    }
    
    // Admin collections (server-side only)
    match /admin/{document=**} {
      allow read, write: if false;
    }
  }
}
